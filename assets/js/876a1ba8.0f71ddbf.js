"use strict";(self.webpackChunkcc_cwebsite=self.webpackChunkcc_cwebsite||[]).push([[1926],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>v});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=r.createContext({}),u=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(o.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(n),m=a,v=p["".concat(o,".").concat(m)]||p[m]||d[m]||i;return n?r.createElement(v,l(l({ref:t},c),{},{components:n})):r.createElement(v,l({ref:t},c))}));function v(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,l=new Array(i);l[0]=m;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[p]="string"==typeof e?e:a,l[1]=s;for(var u=2;u<i;u++)l[u]=n[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},9942:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var r=n(7462),a=(n(7294),n(3905));const i={slug:"sysadmin-mon-chaton-part2",title:"Certificats TLS wildcard avec Letsencrypt, Docker, Traefik via OVH Cloud et Gandi.net",authors:"jonas",keywords:["ubuntu","linux","wallet","traefik","crowsec","administration systeme","sysadmin","ovh","wildcard","letsencrypt","gandi"],tags:["ubuntu","linux","wallet","traefik","crowsec","administration systeme","sysadmin","ovh","wildcard","letsencrypt","gandi"],image:"/img/blog/sauvage.jpg",description:"Soyez sauvage; cr\xe9ez et utilisez des certificats wildcard avec Letsencrypt, Docker, Traefik avec OVH et Gandi.net. Graou !",draft:!1},l="Cr\xe9er et utiliser des certificats wildcard avec Letsencrypt, Docker, Traefik avec OVH et Gandi.net",s={permalink:"/blog/sysadmin-mon-chaton-part2",editUrl:"https://github.com/CoopCodeCommun/CCCWebSite/blog/2023-11-08-wildcard.md",source:"@site/blog/2023-11-08-wildcard.md",title:"Certificats TLS wildcard avec Letsencrypt, Docker, Traefik via OVH Cloud et Gandi.net",description:"Soyez sauvage; cr\xe9ez et utilisez des certificats wildcard avec Letsencrypt, Docker, Traefik avec OVH et Gandi.net. Graou !",date:"2023-11-08T00:00:00.000Z",formattedDate:"8 novembre 2023",tags:[{label:"ubuntu",permalink:"/blog/tags/ubuntu"},{label:"linux",permalink:"/blog/tags/linux"},{label:"wallet",permalink:"/blog/tags/wallet"},{label:"traefik",permalink:"/blog/tags/traefik"},{label:"crowsec",permalink:"/blog/tags/crowsec"},{label:"administration systeme",permalink:"/blog/tags/administration-systeme"},{label:"sysadmin",permalink:"/blog/tags/sysadmin"},{label:"ovh",permalink:"/blog/tags/ovh"},{label:"wildcard",permalink:"/blog/tags/wildcard"},{label:"letsencrypt",permalink:"/blog/tags/letsencrypt"},{label:"gandi",permalink:"/blog/tags/gandi"}],readingTime:7.235,hasTruncateMarker:!1,authors:[{name:"Jonas Turbeaux",title:"Charmeur de python",url:"https://github.com/Nasjoe",imageURL:"/img/jojoCable300Carre.png",key:"jonas"}],frontMatter:{slug:"sysadmin-mon-chaton-part2",title:"Certificats TLS wildcard avec Letsencrypt, Docker, Traefik via OVH Cloud et Gandi.net",authors:"jonas",keywords:["ubuntu","linux","wallet","traefik","crowsec","administration systeme","sysadmin","ovh","wildcard","letsencrypt","gandi"],tags:["ubuntu","linux","wallet","traefik","crowsec","administration systeme","sysadmin","ovh","wildcard","letsencrypt","gandi"],image:"/img/blog/sauvage.jpg",description:"Soyez sauvage; cr\xe9ez et utilisez des certificats wildcard avec Letsencrypt, Docker, Traefik avec OVH et Gandi.net. Graou !",draft:!1},nextItem:{title:'Codons le logiciel de caisse enregistreuse "LaBoutik" depuis zero',permalink:"/blog/codensamb-preambule"}},o={authorsImageUrls:[void 0]},u=[{value:"Vous avez dit sauvage ?",id:"vous-avez-dit-sauvage-",level:2},{value:"Let&#39;s Encrypt et Traefik, l&#39;ultra combo.",id:"lets-encrypt-et-traefik-lultra-combo",level:2},{value:"Pr\xe9requis",id:"pr\xe9requis",level:2},{value:"Installation",id:"installation",level:2},{value:"Avec OVH Cloud",id:"avec-ovh-cloud",level:2},{value:"Avec Gandi.net",id:"avec-gandinet",level:2},{value:"D\xe9collage",id:"d\xe9collage",level:2},{value:"C&#39;est parti !",id:"cest-parti-",level:2},{value:"En production ?",id:"en-production-",level:2},{value:"Sources et liens utiles :",id:"sources-et-liens-utiles-",level:2}],c={toc:u},p="wrapper";function d(e){let{components:t,...i}=e;return(0,a.kt)(p,(0,r.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"/img/blog/sauvage.jpg",src:n(4108).Z,width:"672",height:"384"})),(0,a.kt)("h2",{id:"vous-avez-dit-sauvage-"},"Vous avez dit sauvage ?"),(0,a.kt)("p",null,"Un certificat \"wildcard\" C'est un certificat qui r\xe9pond \xe0 tous les sous-domaines d'un domaine. Par exemple,\nsi vous avez un certificat wildcard pour le domaine ",(0,a.kt)("inlineCode",{parentName:"p"},"*.example.com"),", il sera valide\npour ",(0,a.kt)("inlineCode",{parentName:"p"},"foo.example.com"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"bar.example.com"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"prout.example.com"),", etc."),(0,a.kt)("p",null,"Vous voyez le ",(0,a.kt)("inlineCode",{parentName:"p"},"*")," ? C'est un caract\xe8re joker, qui signifie \"n'importe quoi\". C'est pour cela qu'on appelle \xe7a un\ncertificat wildcard, un sauvage."),(0,a.kt)("p",null,"Pourquoi faire ? Ben c'est quand m\xeame 'achement pratique si on doit g\xe9n\xe9rer des sites en mode Saas, software as a\nservice. TiBillet, par exemple, est construit en mode multi-tenant. Cela veut dire un noyau unique pour plusieurs\ninstances f\xe9d\xe9r\xe9es. Chaque instance est un tenant, et chaque tenant poss\xe8de son propre sous-domaine."),(0,a.kt)("p",null,"Dans le cas d'un d\xe9ploiement en mode \"logiciel \xe0 la demande\", c'est \xe0 dire avec des instances cr\xe9\xe9es automatiquement en\nquelques clics, avoir\nun seul certificat valide pour les adresses comme ",(0,a.kt)("a",{parentName:"p",href:"https://raffinerie.tibillet.re/"},"https//raffinerie.tibillet.re/"),"\nou ",(0,a.kt)("a",{parentName:"p",href:"https://rezom.tibillet.re/"},"https://rezom.tibillet.re/")," (notez le s de https),\nc'est quand m\xeame assez chouette, non ?"),(0,a.kt)("h2",{id:"lets-encrypt-et-traefik-lultra-combo"},"Let's Encrypt et Traefik, l'ultra combo."),(0,a.kt)("p",null,"Pour convaincre Letsencrypt de nous donner un certificat wildcard, il faut faire un petit peu plus de chose que pour un\ncertificat simple.\nEn plus de lui prouver que nous avons bien la main sur le serveur qui r\xe9pond \xe0 l'ip r\xe9solu par le nom de domaine, il\nfaut ausi lui prouver que nous sommes les proprietaires de la totalit\xe9 du domaine. Autrement dit : que nous avons les\ndroits d'\xe9critures de toute la zone DNS."),(0,a.kt)("p",null,"Pour cela, Letsencrypt va nous demander d'ajouter un champ TXT dans la zone DNS du domaine. Ce champ contient une cl\xe9\ncr\xe9\xe9 par Letsencrypt, s'il arrive \xe0 le lire, il va donc consid\xe9rer \xe0 raison que nous avons bien les droits d'\xe9criture\nsur la zone DNS. Donc que nous sommes le proprio."),(0,a.kt)("p",null,"Le truc, c'est qu'un certificat doit se renouveller r\xe9guli\xe8rement, et que donc, il faut que ce champ TXT soit pr\xe9sent et\ndiff\xe9rent \xe0 chaque renouvellement. Et on va pas se le cacher, c'est un peu contraignant et fastidieux de le faire \xe0 la\nmain."),(0,a.kt)("p",null,"C'est la qu'intervient Traefik. Traefik est un reverse proxy, c'est \xe0 dire un serveur qui va rediriger les requ\xeates http\nvers le bon conteneur docker. Il est capable de faire plein de choses, mais ce qui nous int\xe9resse ici, c'est qu'il est\ncapable de g\xe9rer les certificats SSL, et m\xeame de renouveller automatiquement les widlcards."),(0,a.kt)("p",null,"Traefik et Letsencrypt fonctionnent merveilleusement bien ensemble. Le premier va poser la question au second, puis va\nmodifier la zone DNS automatiquement pour que le champs TXT soit \xe0 jour r\xe9guli\xe8rement.\nCela n\xe9cessite de donner les trois d'\xe9criture \xe0 notre Zone \xe0 notre conteneur Traefik.\nPas de soucis particuliers, l'instance Traefik est heberg\xe9 sur notre serveur, nous avons donc la main dessus.."),(0,a.kt)("p",null,"Voyons comment mettre tout \xe7a en place."),(0,a.kt)("h2",{id:"pr\xe9requis"},"Pr\xe9requis"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Un nom de domaine : Ici, nous allons voir la methode avec Gandi et avec OVH"),(0,a.kt)("li",{parentName:"ul"},"Docker ( et docker-compose ) : ",(0,a.kt)("a",{parentName:"li",href:"https://docs.docker.com/install/"},"https://docs.docker.com/install/")),(0,a.kt)("li",{parentName:"ul"},"Traefik : ",(0,a.kt)("a",{parentName:"li",href:"https://docs.traefik.io/"},"https://docs.traefik.io/"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Nous avons un d\xe9pot avec tout dedans : ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/TiBillet/"},"https://github.com/TiBillet/")))),(0,a.kt)("li",{parentName:"ul"},"Un serveur ou heberger tout \xe7a avec une ip statique et les ports 80 et 433 corectement redirig\xe9. On utilise des VPS\nsous Ubuntu, mais \xe7a marche aussi avec une autre distribution ou m\xeame un raspberry pi.")),(0,a.kt)("h2",{id:"installation"},"Installation"),(0,a.kt)("p",null,"Je vous invite \xe0 aller du cot\xe9 d'une pr\xe9c\xe9dente note de blog qui d\xe9taille comment pr\xe9parer votre serveur pour la suite :\n",(0,a.kt)("a",{parentName:"p",href:"https://codecommun.coop/blog/sysadmin-mon-chaton-part1/"},"https://codecommun.coop/blog/sysadmin-mon-chaton-part1/")),(0,a.kt)("p",null,'Une l\xe9g\xe8re diff\xe9rence ceci, nous allons utiliser le fichier docker-compose.yml du dossier "wildcard" de notre d\xe9pot\ngithub Traefik : ',(0,a.kt)("a",{parentName:"p",href:"https://github.com/TiBillet/Traefik-reverse-proxy/tree/main/wildcard"},"https://github.com/TiBillet/Traefik-reverse-proxy/tree/main/wildcard")),(0,a.kt)("p",null,"Si vous avez d\xe9ja lanc\xe9 le docker-compose.yml de la note de blog, vous pouvez le stopper et le supprimer et utiliser\ncelui-ci \xe0 la place."),(0,a.kt)("p",null,"Si vous n'avez de compte ni sous OVH ni chez Gandi, pas d'inqui\xe9tude, Traefik supporte beaucoup de\nregistrar : ",(0,a.kt)("a",{parentName:"p",href:"https://doc.traefik.io/traefik/https/acme/?ref=j.hommet.net#dnschallenge"},"https://doc.traefik.io/traefik/https/acme/?ref=j.hommet.net#dnschallenge")),(0,a.kt)("p",null,"Commen\xe7ons par cr\xe9er un nouveau champ A vers l'ip de votre serveur, avec comme sous domaine ",(0,a.kt)("inlineCode",{parentName:"p"},"*"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"* 10800 IN A <IP>\n")),(0,a.kt)("p",null,"Ensuite, allons g\xe9n\xe9rer une cl\xe9 API pour donner les droits d'\xe9criture dans cette zone \xe0 Traefik : "),(0,a.kt)("h2",{id:"avec-ovh-cloud"},"Avec OVH Cloud"),(0,a.kt)("p",null,"Comme nous le disions, nous allons avoir besoin de donner les droits d'\xe9criture \xe0 Traefik. Il vous faut bien sur un\ncompte ovh valide et avoir achet\xe9 un nom de domaine."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Allez sur ",(0,a.kt)("a",{parentName:"p",href:"https://eu.api.ovh.com/createApp/"},"https://eu.api.ovh.com/createApp/"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Logguez vous, cr\xe9ez une nouvelle app et r\xe9cuperez les cred'")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Dans le m\xeame dossier que le docker-compose, Cr\xe9ez un fichier .env et remplissez les deux premi\xe8res variables avec les\ncred' r\xe9cup\xe9r\xe9s pr\xe9c\xe9demment."))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'OVH_APPLICATION_KEY=""\nOVH_APPLICATION_SECRET=""\nOVH_CONSUMER_KEY=""\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Lancez cette commande curl pour donner les droits de modification \xe0 l'application. Remplacez OVH_APPLICATION_KEY\net VOTRE_DNS, avec vos propres valeurs.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -XPOST -H"X-Ovh-Application: <OVH_APPLICATION_KEY>" -H "Content-type: application/json" \\\nhttps://eu.api.ovh.com/1.0/auth/credential  -d \'{\n    "accessRules": [\n        {\n            "method": "POST",\n            "path": "/domain/zone/<VOTRE_DNS>/record"\n        },\n        {\n            "method": "POST",\n            "path": "/domain/zone/<VOTRE_DNS>/refresh"\n        },\n        {\n            "method": "DELETE",\n            "path": "/domain/zone/<VOTRE_DNS>/record/*"\n        }\n    ],\n    "redirection":"https://www.<VOTRE_DNS>/"\n}\'\n')),(0,a.kt)("p",null,"Si vous n'avez pas curl, installez le. Sinon, vous pouvez aussi utiliser l'application en ligne de OVH. Je vous laisse\nd\xe9couvrir par vous-m\xeame."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Copiez le consumer_key et rentrez la variable correspondante dans le .env"),(0,a.kt)("li",{parentName:"ul"},"Validez la requete avec le lien envoy\xe9 dans la r\xe9ponse. Pensez \xe0 mettre unlimited dans la dur\xe9e des droits d'execution\ncar Traefik renouvelle le widlcard tous les trois mois.")),(0,a.kt)("h2",{id:"avec-gandinet"},"Avec Gandi.net"),(0,a.kt)("p",null,"Un ptit peu plus simple du cot\xe9 de Gandi, il suffit de g\xe9n\xe9rer une cl\xe9 API dans votre compte user / Authentication\noption / API key."),(0,a.kt)("p",null,"Dans votre .env, ajoutez la variable suivante :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'GANDI_API_KEY="PLOUFPLOUFDEVINEMOI"\n')),(0,a.kt)("h2",{id:"d\xe9collage"},"D\xe9collage"),(0,a.kt)("p",null,"Completez votre .env avec EMAIL et DOMAIN, paske c'est le votre et pas le mien :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'DOMAIN="pingoin-sauvage.coop"\nEMAIL="tux42@pingoin-sauvage.coop"\n')),(0,a.kt)("p",null,"Et voici le compose magique :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3"\nservices:\n  traefik:\n    image: "traefik:saintmarcelin"\n    container_name: "traefik_wild"\n    restart: always\n    command:\n      - --log.level=DEBUG\n      - --api.insecure=true\n      - --providers.docker=true\n      - --providers.docker.exposedbydefault=false\n\n      - --entrypoints.web.address=:80\n      - --entrypoints.web.http.redirections.entrypoint.to=websecure\n      - --entrypoints.web.http.redirections.entrypoint.scheme=https\n\n      - --entrypoints.websecure.address=:443\n      - --entrypoints.websecure.http.tls=true\n      - --entrypoints.websecure.http.tls.certResolver=letsencrypt\n      - --entrypoints.websecure.http.tls.domains[0].main=${DOMAIN}\n      - --entrypoints.websecure.http.tls.domains[0].sans=*.${DOMAIN}\n\n      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true\n      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=gandiv5\n      - --certificatesresolvers.letsencrypt.acme.dnschallenge.delayBeforeCheck=60\n      - --certificatesResolvers.letsencrypt.acme.dnsChallenge.resolvers=1.1.1.1:53,8.8.8.8:53\n      - --certificatesresolvers.letsencrypt.acme.email=${EMAIL}\n      - --certificatesresolvers.letsencrypt.acme.storage=/dnschallenge/acme.json\n\n      - --certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory\n\n    ports:\n      - "80:80"\n      - "443:443"\n    environment: # choisissez votre provider. Gardez ceux de Gandi, ou ceux d\'ovh, ou ceux indiqu\xe9 par la doc Traefik.\n      - "GANDIV5_API_KEY=${GANDIV5_API_KEY}"\n      - OVH_APPLICATION_KEY=${OVH_APPLICATION_KEY}\n      - OVH_APPLICATION_SECRET=${OVH_APPLICATION_SECRET}\n      - OVH_CONSUMER_KEY=${OVH_CONSUMER_KEY}\n\n    volumes:\n      - "./dnschallenge:/dnschallenge"\n      - "/var/run/docker.sock:/var/run/docker.sock:ro"\n\n    networks:\n      - frontend\n\nnetworks:\n  frontend:\n    external: true\n\n\n')),(0,a.kt)("p",null,"Attention ! Deux choses \xe0 noter :"),(0,a.kt)("p",null,"Pour gandi, ne touchez pas la ligne suivante :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=gandiv5\n")),(0,a.kt)("p",null,"Pour OVH, ou pour un autre registrar, il faudra bien le changer :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"        - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=ovh\n")),(0,a.kt)("h2",{id:"cest-parti-"},"C'est parti !"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"# On lance le conteneur\ndocker compose up -d\n# on check les logs\ndocker logs -f\n")),(0,a.kt)("p",null,"Attendez quelques instants que les logs se calment, et allons tester tout ceci avec un conteneur de test."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'\nversion: "3"\nservices:\n  whoami:\n    image: "traefik/whoami"\n    container_name: "simple-service"\n    labels:\n      - traefik.enable=true\n      - traefik.docker.network=frontend\n      - traefik.http.routers.whoami.tls.certresolver=letsencrypt\n      - traefik.http.routers.whoami.tls.domains[0].main=${DOMAIN}\n      - traefik.http.routers.whoami.tls.domains[0].sans=*.${DOMAIN}\n\n      - traefik.http.routers.whoami.rule=HostRegexp(`{sub:[a-zA-Z0-9-]+}.${DOMAIN}`) || Host(`${DOMAIN}`)\n      - traefik.http.routers.whoami.entrypoints=websecure\n\n    networks:\n      - frontend\n\nnetworks:\n  frontend:\n    external: true\n\n')),(0,a.kt)("p",null,"Notez la regex sur la r\xe8gle DNS. Elle permet de matcher tous les sous-domaines de votre domaine. Sexy isn't it ?"),(0,a.kt)("p",null,"Si tout ce passe bien, dans les logs de Traefik, vous devriez voir quelque chose comme \xe7a :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},' traefik_wild  | time="2023-11-08T16:40:36Z" level=debug msg="legolog: [INFO] [tibillet.coop] Server responded with a certificate."                                                            traefik_wild  | time="2023-11-08T16:40:36Z" level=debug msg="Certificates obtained for domains [tibillet.coop *.tibillet.coop]" providerName=letsencrypt.acme ACME CA="https://acme-v02.api.le\ntsencrypt.org/directory"             \n')),(0,a.kt)("p",null,"Si non, remontez bien les logs, le probl\xe8me est forc\xe9ment indiqu\xe9 dedans."),(0,a.kt)("h2",{id:"en-production-"},"En production ?"),(0,a.kt)("p",null,"Ahah ! Par ce que vous pensiez que c'\xe9tait fini ?"),(0,a.kt)("p",null,"Le compose de Traefik contien une petite astuce, nous avons utilis\xe9 le serveur de test de Letsencrypt.\nPourquoi ? Eh bien le serveur de production qui g\xe9n\xe8re de vrais certificats est soumis \xe0 une limite du nombre de\ndemande."),(0,a.kt)("p",null,"Je l'ai d\xe9couvert \xe0 mes d\xe9pens, en voulant tester un peu trop de fois mon syst\xe8me, j'ai d\xfb attendre quelques heures pour\npouvoir relancer un nouveau certificat... Le serveur de test nous permet par contre de se planter sans limite. J'adore."),(0,a.kt)("p",null,"Pour passer en production, lorsque les logs du conteneur traefik vous indiqueront que tout roule, il suffit de commenter\nla ligne suivante :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"#      - --certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory\n")),(0,a.kt)("p",null,"Et hop, relancer en mode daemon :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"docker compose up -d\n")),(0,a.kt)("p",null,"Enfin, re-lancez le conteneur whoami et v\xe9rifier qu'il matche bien. Remplacez bien sur le DNS par le votre, lancez le\nconteneur, et allez v\xe9rifier sur votre navigateur que le certificat\nest valide pour tout les sous-domaines que vous souhaitez (https://patate.votre_dns , https://prout.votre_dns, etc...)"),(0,a.kt)("p",null,"Si \xe7a coince, rechargez, videz vos certifs auto g\xe9n\xe9r\xe9s, et enfin regardez les logs Traefik, ce dernier vous signalera\nforcement le probl\xe8me dans un message d'erreur."),(0,a.kt)("h2",{id:"sources-et-liens-utiles-"},"Sources et liens utiles :"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://doc.traefik.io/traefik/user-guides/docker-compose/acme-dns/"},"https://doc.traefik.io/traefik/user-guides/docker-compose/acme-dns/")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.grottedubarbu.fr/traefik-dns-challenge-ovh/"},"https://www.grottedubarbu.fr/traefik-dns-challenge-ovh/")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://j.hommet.net/traefik-certificat-ssl-wildcard-letsencrypt/"},"https://j.hommet.net/traefik-certificat-ssl-wildcard-letsencrypt/"))))}d.isMDXComponent=!0},4108:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/sauvage-bdca871ed181cf44e12a51620a5858dc.jpg"}}]);